# =========================================================
# BLOQUE 1: REDIRECCIÓN DE HTTP A HTTPS (Puerto 80)
# =========================================================
server {
    listen 80;
    # El guion bajo (_) captura CUALQUIER nombre o IP
    server_name _; 
    return 301 https://$host$request_uri;
}

# =========================================================
# BLOQUE 2: SERVIDOR SEGURO (Puerto 443)
# =========================================================
server {
    listen 443 ssl;
    # El guion bajo (_) es CRUCIAL para que funcione con IPs
    server_name _;

    # --- CERTIFICADOS SSL ---
    ssl_certificate     /etc/nginx/certs/fitmanager.crt;
    ssl_certificate_key /etc/nginx/certs/fitmanager.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # =========================================================
    # REGLA EXTRA: RAÍZ -> LOGIN
    # =========================================================
    # Si entras a https://192.168.x.x/ te manda al login

    # =========================================================
    # 1. RUTAS DEL BACKEND (LARAVEL) - LA LISTA VIP
    # =========================================================
    # Si la URL contiene alguna de estas palabras, se va al backend.
    
    location ~ ^/(home|nutrition|training|routines|crear-dieta|info-producto|privacidad|admin|api|login|register|logout|sanctum|csrf-cookie|profile|profile-update|reviews|perfil|forgot-password|reset-password|verify-email|confirm-password|password|email) {
        proxy_pass http://backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; 
        proxy_set_header X-Forwarded-Host $host; 
        
        # IMPORTANTE: Aumentar tiempos de espera por si Laravel tarda
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # =========================================================
    # 2. RECURSOS (CSS/JS/IMG)
    # =========================================================
    # Todo lo que empiece por /css, /js, etc. va al backend (Vite)
    location ~ ^/(css|js|img|storage|build|fonts)/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
    }

    # =========================================================
    # 3. FALLBACK FRONTEND (Todo lo demás)
    # =========================================================
    location / {
        proxy_pass http://frontend:80;
        proxy_intercept_errors on;
        error_page 404 = /index.html; 
    }
}